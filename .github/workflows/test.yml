name: CI

on:
  push:
    branches:
      - 'main'
      - '*.*'
    tags:
      - 'v*'
  pull_request:
  workflow_dispatch:

jobs:
  test:
    uses: OpenAstronomy/github-actions-workflows/.github/workflows/tox.yml@v1
    with:
      toxdeps: tox-pypi-filter
      envs: |
        - macos: py312
        - windows: py312
        - linux: py310
        - linux: py311
        - linux: py312
        - linux: py313
      coverage: 'codecov'
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
  codestyle:
    uses: OpenAstronomy/github-actions-workflows/.github/workflows/tox.yml@v1
    with:
      toxdeps: tox-pypi-filter
      envs: |
        - linux: codestyle
          python-version: '3.11'
  docs:
    needs: [test]
    uses: OpenAstronomy/github-actions-workflows/.github/workflows/tox.yml@v1
    with:
      toxdeps: tox-pypi-filter
      envs: |
        - linux: build_docs
          python-version: '3.12'
  publish:
    # Build wheels when pushing to any branch except main
    # publish.yml will only publish if tagged ^v.*
    if: |
      (
        github.event_name != 'pull_request' && (
          github.ref_name != 'main' ||
          github.event_name == 'workflow_dispatch'
        )
      ) || (
        github.event_name == 'pull_request' &&
        contains(github.event.pull_request.labels.*.name, 'Run publish')
      )
    needs: [test]
    uses: OpenAstronomy/github-actions-workflows/.github/workflows/publish_pure_python.yml@main
    with:
      test_extras: 'dev'
      test_command: 'pytest -p no:warnings --doctest-rst --pyargs pydrad'
      submodules: false
      python-version: '3.12'
    secrets:
      pypi_token: ${{ secrets.PYPI_TOKEN }}

  windows_cygwin_test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Cygwin with gcc, g++, make, python3.12
        shell: pwsh
        run: |
          curl -L -o setup-x86_64.exe https://cygwin.com/setup-x86_64.exe
          ./setup-x86_64.exe -qn -R C:\cygwin64 -s http://cygwin.mirror.constant.com -P gcc-g++,make,python312,python312-pip,python312-setuptools > cygwin_install.log 2>&1
          cat cygwin_install.log
          if ($LASTEXITCODE -ne 0) { throw "Cygwin install failed" }

      - name: Add Cygwin to PATH
        shell: pwsh
        run: echo "C:\\cygwin64\\bin" >> $env:GITHUB_PATH

      - name: Verify Cygwin Python and GCC
        shell: bash
        run: |
          which python3
          /usr/bin/python3 --version
          g++ --version

      - name: Install Python dependencies
        shell: bash
        run: |
          cd "$(cygpath "$GITHUB_WORKSPACE")"
          /usr/bin/python3 -m pip install --upgrade pip
          /usr/bin/python3 -m pip install -e .

      - name: Run tests with pytest
        shell: bash
        run: |
          cd "$(cygpath "$GITHUB_WORKSPACE")"
          pytest
